<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/images/Logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/editor.css">
    <title>Code</title>
</head>
<body>
    <head-element></head-element>
    <div class="main-bod">
        <div class="whole-editor">
            <div class="left-side">
                <div class="title">
                    <h4>Language: </h4>
                    <select id="language" class="form-select">
                        <option value="java" selected>Java</option>
                        <option value="csharp">C#</option>
                        <option value="python">Python</option>
                    </select>
                    <button id="run-btn" class="custom-btn btn-1">Run</button>
                </div>
                <div id="editor" class="editor">// Code Here</div>
                <div id="input-div" class="input-section" style="display: none;">
                    <h4>Input:</h4>
                    <textarea id="user-input" class="form-control" rows="4"></textarea>
                </div>
            </div>
            <div class="right-side">
                <div class="title">
                    <h4>Output:</h4>
                </div>
                <div id="output" class="output"></div>
            </div>
        </div>
    </div>
    <chat-head></chat-head>
    <foot-element></foot-element>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.36.4/ace.js"></script>
    <script>
        const API_URL = "https://emkc.org/api/v2/piston/execute";

        let editor;

        // Initialize the Ace editor
        window.onload = function () {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/java");

            // Update editor mode on language change
            document.getElementById("language").addEventListener("change", function () {
                const lang = this.value;
                const mode = lang === "java" ? "java" : lang === "csharp" ? "csharp" : "python";
                editor.session.setMode(`ace/mode/${mode}`);
            });
        };

        // Detect if the program needs input
        const needsInput = (language, code) => {
            if (language === "java" && (code.includes("Scanner") || code.includes("System.in"))) {
                return true;
            } else if (language === "csharp" && (code.includes("Console.ReadLine()") || code.includes("Console.Read"))) {
                return true;
            } else if (language === "python" && (code.includes("input()"))) {
                return true;
            }
            return false;
        };

        // Show input field for programs needing user input
        document.getElementById("run-btn").addEventListener("click", async () => {
            const code = editor.getValue();
            const language = document.getElementById("language").value;
            const outputDiv = document.getElementById("output");
            const inputDiv = document.getElementById("input-div");

            outputDiv.textContent = "Running...";

            // Check if code needs input and show the input field
            if (needsInput(language, code)) {
                inputDiv.style.display = "block";
                return;
            }

            // Proceed with code execution if no user input is needed
            inputDiv.style.display = "none"; // Hide input if not required

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        language,
                        version: "*",
                        files: [{ name: "main", content: code }],
                    }),
                });

                const result = await response.json();
                outputDiv.textContent = result.run?.output || "No output or an error occurred.";
            } catch (error) {
                outputDiv.textContent = `Error: ${error.message}`;
            }
        });

        // Handle user input submission for programs requiring input (when Enter key is pressed)
        document.getElementById("user-input").addEventListener("keypress", async (event) => {
            if (event.key === "Enter") {
                const code = editor.getValue();
                const language = document.getElementById("language").value;
                const outputDiv = document.getElementById("output");
                let userInput = document.getElementById("user-input").value;

                outputDiv.textContent = "Running...";

                // For Python, split multi-line inputs into separate lines for stdin
                if (language === "python") {
                    // Split input into separate lines based on new lines
                    userInput = userInput.split("\n").map(line => line.trim()).join("\n");  // Ensure proper line breaks for Python input
                }

                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            language,
                            version: "*",
                            files: [{ name: "main", content: code }],
                            stdin: userInput, // Pass user input as stdin
                        }),
                    });

                    const result = await response.json();
                    outputDiv.textContent = result.run?.output || "No output or an error occurred.";
                    document.getElementById("input-div").style.display = "none"; // Hide input area after submission
                } catch (error) {
                    outputDiv.textContent = `Error: ${error.message}`;
                }
            }
        });
    </script>
    <script src="../js/header-footer.js"></script>
    <script type="module" src="../js/account.js"></script>
</body>
</html>
